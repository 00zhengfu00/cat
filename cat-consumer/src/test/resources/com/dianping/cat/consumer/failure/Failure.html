<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" media="screen"
	href="../jquery/jquery-ui-1.8.16.custom.css" />
<link rel="stylesheet" type="text/css" media="screen"
	href="../jquery/ui.jqgrid.css" />
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script type="text/javascript" src="../jquery/grid.locale-en.js"></script>
<script type="text/javascript" src="../jquery/jquery.jqGrid.min.js"></script>
</head>
<body>
	<script type="text/javascript">
	
		var test = {
			"Minute" : "2012-01-10 13:00",
			"Thread0" : "<a target='_blank' href='http://www.dianping.com/messageId=MessageId0'> E</a>",
			"Thread1" : "<a target='_blank' href='http://www.dianping.com/messageId=MessageId0'> R</a>",
			"Thread2" : "<a target='_blank' href='http://www.dianping.com/messageId=MessageId0'> L</a>",
			"Thread3" : "",
			"Thread4" : ""
		}
		var jsonDate = {
			"domain" : "domain1",
			"startTime" : "2012-1-10 13:00:00",
			"endTime" : "2012-1-10 13:59:00",
			"machines" : {
				"machines" : [ "192.168.8.0", "192.168.8.1", "192.168.8.2",
						"192.168.8.3" ]
			},
			"threads" : {
				"threads" : [ "Thread0", "Thread1", "Thread2", "Thread3",
						"Thread4" ]
			},
			"segments" : [ {
				"2012-01-10 13:00" : {
					"id" : "2012-01-10 13:00",
					"entries" : [ {
						"type" : "Exception",
						"messageId" : "MessageId0",
						"threadId" : "Thread0",
						"text" : "java.lang.NullPointException"
					}, {
						"type" : "Error",
						"messageId" : "MessageId0",
						"threadId" : "Thread1",
						"text" : "java.lang.RuntimeError"
					}, {
						"type" : "LongUrl",
						"messageId" : "MessageId0",
						"threadId" : "Thread2",
						"text" : "AAA:BBBB"
					} ]
				},
				"2012-01-10 13:01" : {
					"id" : "2012-01-10 13:01",
					"entries" : [ {
						"type" : "Error",
						"messageId" : "MessageId1",
						"threadId" : "Thread1",
						"text" : "java.lang.RuntimeError"
					}, {
						"type" : "RuntimeException",
						"messageId" : "MessageId1",
						"threadId" : "Thread1",
						"text" : "java.lang.RuntimeException"
					}, {
						"type" : "Error",
						"messageId" : "MessageId1",
						"threadId" : "Thread1",
						"text" : "java.lang.RuntimeError"
					} ]
				},
				"2012-01-10 13:02" : {
					"id" : "2012-01-10 13:02",
					"entries" : [ {
						"type" : "Error",
						"messageId" : "MessageId2",
						"threadId" : "Thread2",
						"text" : "java.lang.RuntimeError"
					}, {
						"type" : "Error",
						"messageId" : "MessageId2",
						"threadId" : "Thread2",
						"text" : "java.lang.RuntimeError"
					}, {
						"type" : "Error",
						"messageId" : "MessageId2",
						"threadId" : "Thread4",
						"text" : "java.lang.RuntimeError"
					} ]
				},
				"2012-01-10 13:03" : {
					"id" : "2012-01-10 13:03",
					"entries" : [ {
						"type" : "Exception",
						"messageId" : "MessageId3",
						"threadId" : "Thread3",
						"text" : "java.lang.Exception"
					}, {
						"type" : "Exception",
						"messageId" : "MessageId3",
						"threadId" : "Thread4",
						"text" : "java.lang.Exception"
					}, {
						"type" : "Exception",
						"messageId" : "MessageId3",
						"threadId" : "Thread1",
						"text" : "java.lang.Exception"
					} ]
				},
				"2012-01-10 13:04" : {
					"id" : "2012-01-10 13:04",
					"entries" : [ {
						"type" : "RuntimeException",
						"messageId" : "MessageId4",
						"threadId" : "Thread4",
						"text" : "java.lang.RuntimeException"
					}, {
						"type" : "Error",
						"messageId" : "MessageId4",
						"threadId" : "Thread1",
						"text" : "java.lang.RuntimeError"
					}, {
						"type" : "Exception",
						"messageId" : "MessageId4",
						"threadId" : "Thread2",
						"text" : "java.lang.RuntimeException"
					} ]
				}
			} ]
		};
		var jsObject = eval(jsonDate);
		var threadArray = new Array();
		threadArray.push('Minute');

		for (i = 0; i < jsObject.threads.threads.length; i++) {
			threadArray.push(jsObject.threads.threads[i]);
		}

		var colModelArray = new Array();

		for (i = 0; i < threadArray.length; i++) {
			var object = {
				"name" : threadArray[i],
				"index" : threadArray[i],
				"sorttype" : "string"
			};
			colModelArray.push(object);
		}

		$(function() {
			$("#failureTable").jqGrid({
				datatype : "local",
				colNames : threadArray,
				colModel : colModelArray,
				viewrecords : true,
				caption : "Failure Report",
				height : 250,
				loadComplete : function() {
					var grid = $("#failureTable");
					var ids = grid.getDataIDs();
					for ( var i = 0; i < ids.length; i++) {
						grid.setRowData(ids[i], false, {
							height : 25
						});
					}
					grid.setGridHeight('auto');
				}
			}).navGrid('#pager2', {
				edit : false,
				add : false,
				del : false
			});
			
			jQuery("#failureTable").jqGrid('setGridWidth','1500');
			for ( var i = 0; i < jsObject.segments.length; i++) {
				var segments = jsObject.segments[i];

				for ( var minute in segments) {
					var threadResult = creatNewArray(threadArray.length);
					threadResult[0] = minute;
					var segment = segments[minute];
					for ( var j = 0; j < segment.entries.length; j++) {
						var entry = segment.entries[j];
						var threadId = entry.threadId;
						var type = entry.type;
						var messageId = entry.messageId;
						var text = entry.text;
						
						var index = getIndex(threadId, threadArray);
						var url = getUrl(type,text, messageId);
						if(threadResult[index]==""){
						threadResult[index] = threadResult[index] + url;
						}
						else{
							threadResult[index] = threadResult[index] +'</br>'+ url;
						}
					}
					var minuteData = {};
					for ( var i = 0; i < threadArray.length; i++) {
						minuteData[threadArray[i]] =  threadResult[i];
					}
					jQuery("#failureTable").jqGrid('addRowData', i + 1,
							minuteData);
				}
			}
		});
		function creatNewArray(length) {
			var array = new Array();
			for ( var i = 0; i < length; i++) {
				array.push("");
			}
			return array;
		}

		function getIndex(object, array) {
			for ( var i = 0; i < array.length; i++) {
				if (array[i] == object)
					return i;
			}
		}

		function getUrl(type, text ,messageId) {
			if (type == 'RuntimeException') {
				return '<a target=\'_blank\' style=\'background:red;\' href=\'www.dianping.com/messageId=' + messageId + '\'>' + text + '</a>';
			} else if (type == 'Exception') {
				return '<a target=\'_blank\' style=\'background:#FFFF00;\' href=\'www.dianping.com/messageId=' + messageId + '\'>' + text + '</a>';
			} else if (type == 'Error') {
				return '<a target=\'_blank\' style=\'background:#FF00FF;\' href=\'www.dianping.com/messageId=' + messageId + '\'>' + text + '</a>';
			} else {
				return '<a target=\'_blank\' style=\'background:#CC99FF;\' href=\'www.dianping.com/messageId=' + messageId + '\'>' + text + '</a>';
			}
		}
	</script>

	
	<div style="align:center;width:90%;text-align:center">
		<table id="gridTable"></table>
		<table id="failureTable"></table>
	</div>
</body>
</html>