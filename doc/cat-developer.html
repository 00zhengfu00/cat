<p><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></head></p>
<h1 id="++">背景</h1>
<p>本文描述了CAT的概要结构, 以及如何使用cat分析应用程序的方法和最佳实践. 这篇文档是第1版, 我们会尽快增加更丰富的内容. 如果你有任何问题, 请联系CAT团队成员.</p>
<hr />
<h1 id="++++">概要介绍</h1>
<p><img alt="arch overview" src="img/test.png" /></p>
<hr />
<h1 id="++++_1">环境设置</h1>
<h2 id="++_1">依赖</h2>
<p>如果你的java项目基于maven管理,仅需要在pom.xml里加入cat-core项目依赖即可.</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.dianping.cat&lt;/groupId&gt;
    &lt;artifactId&gt;cat-core&lt;/artifactId&gt;
    &lt;version&gt;0.2.4&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>同时你需要确认你的maven的conf.xml配置的是点评公司的仓库地址.</p>
<h2 id="++++_2">配置文件</h2>
<p>你需要修改这个文件:/data/appdatas/cat/client.xml, windows机器前面还要加上程序当前运行根目录所在的盘符.</p>
<pre><code>&lt;config mode=&quot;client&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema&quot; xsi:noNamespaceSchemaLocation=&quot;config.xsd&quot;&gt;
        &lt;servers&gt;
                &lt;server ip=&quot;192.168.7.43&quot;/&gt;
        &lt;/servers&gt;
        &lt;domain id=&quot;your domain id&quot;/&gt;
&lt;/config&gt;
</code></pre>

<dl>
<dt>server</dt>
<dd>ip表示cat客户端收集到的消息发送的cat服务器. 测试服务器地址http://192.168.7.43:8080/cat/r . 线上的应用一般配多个server来实现容灾和负载均衡.</dd>
<dt>domain</dt>
<dd>id表示消息归属的domain name, 这会体现在cat服务端实时报表的domain分类上. 如果需要关闭cat消息收集, domain节点增加属性项enable="false"即可.</dd>
</dl>
<hr />
<h1 id="cat++api">CAT消息API</h1>
<h2 id="++++_3">消息协议</h2>
<p>CAT客户端可以向服务端发送Transaction, Event, Heartbeat三种消息. 消息的传输格式如下:</p>
<pre><code>&lt;Class&gt;&lt;Timestamp&gt;\t&lt;Type&gt;\t&lt;Name&gt;[\t&lt;Status][\t&lt;Duration&gt;][\t&lt;Data&gt;]
</code></pre>

<p>如:</p>
<pre><code>H2012-04-26 16:00:42.775        Heartbeat       192.168.63.141  0  &lt;os name=&quot;Mac OS X&quot; arch=&quot;x86_64&quot; version=&quot;Mac OS X&quot;/&gt;
</code></pre>

<h3 id="class">Class</h3>
<dl>
<dt>有5种Cat消息类别, 每种类别用1个字符表示:</dt>
<dt>t</dt>
<dd>Transaction开始 </dd>
<dt>T</dt>
<dd>Transaction结束</dd>
<dt>A</dt>
<dd>Atomic Transaction</dd>
<dt>E</dt>
<dd>Event</dd>
<dt>H</dt>
<dd>Heartbeat</dd>
</dl>
<h3 id="transaction">Transaction</h3>
<p>某些运行期单元要花费一定时间完成工作, 内部需要其他处理逻辑协助, 我们定义为Transaction. Transaction可以嵌套(如http请求过程中嵌套了sql处理). 大部分的Transaction可能会失败, 因此需要一个结果状态码. 如果Transaction开始和结束之间没有其他消息产生, 那它就是Atomic Transaction(合并了起始标记).</p>
<h3 id="heartbeat">Heartbeat</h3>
<p>Heartbeta表示程序内定期产生的统计信息, 如CPU%, MEM%, 连接池状态, 系统负载等.</p>
<h3 id="event">Event</h3>
<p>Event表示所有其他不能归属到Transaction或者Heartbeat的消息. 包括警告, 错误, 业务提示信息, 以及CAT自身的内部信息.</p>
<h3 id="timestamp">Timestamp</h3>
<p>记录消息产生的时刻, 格式"yyyy-mm-dd HH:MM:SS.sss".</p>
<h3 id="type">Type</h3>
<p>大小写敏感的字符串. 常见的Transaction type有 "URL", "SQL", "Email", "Exec"等. 常见的Event type有 "Info", "Warn", "Error", 还有"Cat"用来表示Cat内部的消息.</p>
<h3 id="name">Name</h3>
<p>大小写敏感的字符串. type和name的组合要满足全局唯一性. 常见的URL transaction type的name如 "ViewItem", "MakeBid", "SignIn"等. SQL transaction type的name如 "AddFeedback", "GetAccountDetailUnit4", "IncrementFeedbackAndTotalScore"等.</p>
<h3 id="status">Status</h3>
<p>大小写敏感的字符串. 0表示成功, 非零表示失败. 建议不要使用太长的字符串. Transaction start没有status字段.</p>
<h3 id="duration">Duration</h3>
<p>精确到0.1毫秒. 表示transaction start和transaction end之间的时间长度. 仅出现在Transaction end或者Atomic Transaction. Event和Heartbeat没有duration字段.</p>
<h3 id="data">Data</h3>
<p>建议使用以&amp;字符分割的name=value对组成的字符串列表. Transaction start没有data字段.</p>
<h2 id="++_2">实现</h2>
<p>我们建议程序内部跨越边界访问的活动都需要记录下Cat消息. 另外, 三种基本消息Transaction, Event, Heartbeat何时使用, 请参见下图:</p>
<p><img alt="" src="img/cat-message-desicion.png" /></p>
<h3 id="transaction_1">Transaction</h3>
<p>当你准备要使用Transaction时,请遵循下图的流程:</p>
<p><img alt="" src="img/cat-transaction-desicion.png" /></p>
<p>这里是Transaction的api:</p>
<p>com.dianping.cat.message.MessageProducer:</p>
<pre><code class="java">        Transaction newTransaction(String type, String name);
</code></pre>

<p>com.dianping.cat.message.Transaction:</p>
<pre><code class="java">        void addData(String keyValuePairs);

        void addData(String key, Object value);

        void setStatus(String status);

        void complete();
</code></pre>

<h3 id="event_1">Event</h3>
<p>当你准备要使用event时,请遵循下图的流程:</p>
<p><img alt="" src="img/cat-event-desicion.png" /></p>
<p>这里是Event的api:</p>
<p>com.dianping.cat.message.MessageProducer:</p>
<pre><code class="java">        void logEvent(String type, String name, String status, String keyValuePairs);

        Event newHeartbeat(String type, String name);
</code></pre>

<p>com.dianping.cat.message.Event:</p>
<pre><code class="java">        void addData(String keyValuePairs);

        void addData(String key, Object value);

        void setStatus(String status);

        void complete();
</code></pre>

<h3 id="heartbeat_1">Heartbeat</h3>
<p>当你准备要使用heartbeat时,请遵循下图的流程:</p>
<p><img alt="" src="img/cat-heartbeat-desicion.png" /></p>
<p>这里是Heartbeat的api:</p>
<p>com.dianping.cat.message.MessageProducer:</p>
<pre><code class="java">        void logHeartbeat(String type, String name, String status, String keyValuePairs);

        Heartbeat newHeartbeat(String type, String name);
</code></pre>

<p>com.dianping.cat.message.Heartbeat:</p>
<pre><code class="java">        void addData(String keyValuePairs);

        void addData(String key, Object value);

        void setStatus(String status);

        void complete();
</code></pre>

<h2 id="++++cat+++++">已经实现Cat集成的框架</h2>
<h3 id="avataravatar-biz_url_action">Avatar/Avatar-Biz (URL, Action)</h3>
<h3 id="zebra_sql">Zebra (SQL)</h3>
<h3 id="pigeon_call_result">Pigeon (Call, Result)</h3>
<h3 id="ox_tbd">Ox (TBD)</h3>
<h3 id="swallow_tbd">Swallow (TBD)</h3>
<hr />
<h1 id="++++_4">插件开发</h1>
<h2 id="++++++">实时报表插件</h2>
<p>Cat服务端接收到消息后, 分发给报表插件模块. 实时生成报表. 目前有Transaction, Event, Heartbeat, Problem, IP等5张实时报表. 如业务需要增加新的实时报表, 请练习Cat团队.</p>
<h2 id="hadoop++">Hadoop任务</h2>
<p>Cat服务端每隔1小时会把所有的消息备份到hdfs服务器, 定期执行的hadoop job分析备份数据, 生成SQL统计报表. 如业务需要增加新的统计报表, 请练习Cat团队.</p>
<hr />
<h1 id="faq">FAQ</h1>
<h2 id="cat+++">Cat是什么</h2>
<p>Cat是通过客户端埋点实时收集程序运行消息, 在服务端分析程序运行状况, 生成统计报表的工具.</p>
<h2 id="cat++++">Cat不是什么</h2>
<ul>
<li>Cat需要客户端埋点来收集程序运行消息, 不要指望它能发现埋点范围之外的问题.</li>
<li>Cat能帮助你发现问题, 但是不能帮你解决问题</li>
</ul>